{
    # Enable debug logging temporarily
    debug
    order layer4 first
}

# Layer 4 proxy for LiveKit UDP
layer4 {
    listen :7881
    proxy {
        upstream livekit:7881
    }
}

# LiveKit WebRTC endpoint
lk.getautom8.app {
    reverse_proxy livekit:7880 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Add CORS headers for WebRTC
    header Access-Control-Allow-Origin *
    header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
    
    # Handle preflight requests
    respond /options 204
}

# Main API endpoints
getautom8.app, api.getautom8.app {
    # Add health check endpoint for debugging
    handle /health {
        respond "Caddy OK" 200
    }
    
    # Main reverse proxy
    reverse_proxy server:8000 {
        # Health check settings
        health_uri /v1/health
        health_interval 10s
        health_timeout 5s
        
        # Headers for proper forwarding
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Port {server_port}
        
        # Timeout settings
        transport http {
            dial_timeout 10s
            response_header_timeout 10s
        }
    }
    
    # Enable access logs for debugging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}