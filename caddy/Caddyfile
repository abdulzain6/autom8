# Global options
{
    debug
    
    # Corrected Layer4 app configuration
    layer4 {
        # This block handles the UDP media range using the correct syntax.
        udp/:50000-60000 {
            route {
                proxy livekit
            }
        }

        # This block handles the TCP fallback.
        tcp/:7881 {
            route {
                proxy livekit:7881
            }
        }
    }
}

# LiveKit WebRTC endpoint (HTTP/S)
lk.getautom8.app {
    # Add CORS headers for WebRTC. This handles OPTIONS preflight automatically.
    @options method OPTIONS
    respond @options 204
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers *
        -Server
    }

    reverse_proxy livekit:7880 {
        header_up Host {host}
        header_up X-Forwarded-For {remote_host}
    }
}

# Main API endpoints
getautom8.app, api.getautom8.app {
    # Log to stdout/stderr in JSON format so 'docker-compose logs' can capture it
    log {
        output stderr
        format json
    }

    # Main reverse proxy to your application server
    reverse_proxy server:8000 {
        # Active health checks
        health_uri /v1/health
        health_interval 10s
        health_timeout 5s
        
        # Headers for proper forwarding
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}